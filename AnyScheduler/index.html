<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CombineSchedulers - AnyScheduler</title>
    <link rel="stylesheet" type="text/css" href="/combine-schedulers/all.css" media="all" />
</head>
<body>
    <header>
        <a href="/combine-schedulers/">
            <strong>
                CombineSchedulers
            </strong>
            <span>Documentation</span>
        </a>
    </header>

    <!--
    <form class="search">
        <input type="search" placeholder="Search" />
    </form>
    -->

    <nav>
        <div class="wrapper">
            <h2>On This Page</h2>
            <ol><li><a href="#relationships">Relationships</a><ul><li><a href="#relationships">Conforms To</a></li></ul></li><li><a href="#initializers">Initializers</a><ul><li class="initializer"><a href="#anyscheduler.init(minimumtolerance:now:scheduleimmediately:delayed:interval:)">init(minimum​Tolerance:​now:​schedule​Immediately:​delayed:​interval:​)</a></li><li class="initializer"><a href="#anyscheduler.init(_:)">init(_:​)</a></li></ul></li><li><a href="#properties">Properties</a><ul><li class="variable"><a href="#anyscheduler.minimumtolerance">minimum​Tolerance</a></li><li class="variable"><a href="#anyscheduler.now">now</a></li></ul></li><li><a href="#methods">Methods</a><ul><li class="function"><a href="#anyscheduler.schedule(after:tolerance:options:_:)">schedule(after:​tolerance:​options:​_:​)</a></li><li class="function"><a href="#anyscheduler.schedule(after:interval:tolerance:options:_:)">schedule(after:​interval:​tolerance:​options:​_:​)</a></li><li class="function"><a href="#anyscheduler.schedule(options:_:)">schedule(options:​_:​)</a></li></ul></li></ol>
        </div>
    </nav>

    <main>
        <article>
            <h1>
    <small>Structure</small>
    <code class="name">Any​Scheduler</code>
</h1>

<div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">struct</span> <span class="type">AnyScheduler</span>&lt;<span class="variable">SchedulerTimeType</span>, <span class="variable">SchedulerOptions</span>&gt;: <span class="type">Scheduler</span>
<span class="keyword">where</span>
  <span class="type">SchedulerTimeType</span>: <span class="type">Strideable</span>,
  <span class="type">SchedulerTimeType</span>.<span class="type">Stride</span>: <span class="type">SchedulerTimeIntervalConvertible</span></body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>A type-erasing wrapper for the <code>Scheduler</code> protocol, which can be useful for being generic over
many types of schedulers without needing to actually introduce a generic to your code.</p>

</div>
<div class="discussion">
    <p>This type is useful for times that you want to be able to customize the scheduler used in some
code from the outside, but you don't want to introduce a generic to make it customizable. For
example, suppose you have a view model <code>ObservableObject</code> that performs an API request when a
method is called:</p>

<html><body><pre class="highlight"><code><span class="keyword">class</span> <span class="type">EpisodeViewModel</span>: <span class="type">ObservableObject</span> {
  <span class="attribute">@</span><span class="type">Published</span> <span class="keyword">var</span> <span class="variable">episode</span>: <span class="type">Episode</span>?

  <span class="keyword">let</span> <span class="variable">apiClient</span>: <span class="type">ApiClient</span>

  <span class="keyword">init</span>(<span class="variable">apiClient</span>: <span class="type">ApiClient</span>) {
    <span class="keyword">self</span>.<span class="variable">apiClient</span> = <span class="variable">apiClient</span>
  }

  <span class="keyword">func</span> <span class="function">reloadButtonTapped</span>() {
    <span class="keyword">self</span>.<span class="variable">apiClient</span>.<span class="variable">fetchEpisode</span>()
      .<span class="variable">receive</span>(<span class="variable">on</span>: <span class="type">DispatchQueue</span>.<span class="variable">main</span>)
      .<span class="variable">assign</span>(<span class="variable">to</span>: &amp;<span class="keyword">self</span>.<span class="variable">$episode</span>)
  }
}
</code></pre></body></html>
<p>Notice that we are using <code>DispatchQueue.main</code> in the <code>reloadButtonTapped</code> method because the
<code>fetchEpisode</code> endpoint most likely delivers its output on a background thread (as is the case
with <code>URLSession</code>).</p>

<p>This code seems innocent enough, but the presence of <code>.receive(on: DispatchQueue.main)</code> makes
this code harder to test since you have to use <code>XCTest</code> expectations to explicitly wait a small
amount of time for the queue to execute. This can lead to flakiness in tests and make test
suites take longer to execute than necessary.</p>

<p>One way to fix this testing problem is to use an &quot;immediate&quot; scheduler instead of
<code>DispatchQueue.main</code>, which will cause <code>fetchEpisode</code> to deliver its output as soon as possible
with no thread hops. In order to allow for this we would need to inject a scheduler into our
view model so that we can control it from the outside:</p>

<html><body><pre class="highlight"><code><span class="keyword">class</span> <span class="type">EpisodeViewModel</span>&lt;<span class="variable">S</span>: <span class="type">Scheduler</span>&gt;: <span class="type">ObservableObject</span> {
  <span class="attribute">@</span><span class="type">Published</span> <span class="keyword">var</span> <span class="variable">episode</span>: <span class="type">Episode</span>?

  <span class="keyword">let</span> <span class="variable">apiClient</span>: <span class="type">ApiClient</span>
  <span class="keyword">let</span> <span class="variable">scheduler</span>: <span class="type">S</span>

  <span class="keyword">init</span>(<span class="variable">apiClient</span>: <span class="type">ApiClient</span>, <span class="variable">scheduler</span>: <span class="type">S</span>) {
    <span class="keyword">self</span>.<span class="variable">apiClient</span> = <span class="variable">apiClient</span>
    <span class="keyword">self</span>.<span class="variable">scheduler</span> = <span class="variable">scheduler</span>
  }

  <span class="keyword">func</span> <span class="function">reloadButtonTapped</span>() {
    <span class="keyword">self</span>.<span class="variable">apiClient</span>.<span class="variable">fetchEpisode</span>()
      .<span class="variable">receive</span>(<span class="variable">on</span>: <span class="keyword">self</span>.<span class="variable">scheduler</span>)
      .<span class="variable">assign</span>(<span class="variable">to</span>: &amp;<span class="keyword">self</span>.<span class="variable">$episode</span>)
  }
}
</code></pre></body></html>
<p>Now we can initialize this view model in production by using <code>DispatchQueue.main</code> and we can
initialize it in tests using <code>DispatchQueue.immediate</code>. Sounds like a win!</p>

<p>However, introducing this generic to our view model is quite heavyweight as it is loudly
announcing to the outside world that this type uses a scheduler, and worse it will end up
infecting any code that touches this view model that also wants to be testable. For example,
any view that uses this view model will need to introduce a generic if it wants to also be able
to control the scheduler, which would be useful if we wanted to write snapshot tests.</p>

<p>Instead of introducing a generic to allow for substituting in different schedulers we can use
<code>AnyScheduler</code>. It allows us to be somewhat generic in the scheduler, but without actually
introducing a generic.</p>

<p>Instead of holding a generic scheduler in our view model we can say that we only want a
scheduler whose associated types match that of <code>DispatchQueue</code>:</p>

<html><body><pre class="highlight"><code><span class="keyword">class</span> <span class="type">EpisodeViewModel</span>: <span class="type">ObservableObject</span> {
  <span class="attribute">@</span><span class="type">Published</span> <span class="keyword">var</span> <span class="variable">episode</span>: <span class="type">Episode</span>?

  <span class="keyword">let</span> <span class="variable">apiClient</span>: <span class="type">ApiClient</span>
  <span class="keyword">let</span> <span class="variable">scheduler</span>: <a href="/combine-schedulers/AnySchedulerOf"><span class="type">AnySchedulerOf</span></a>&lt;<span class="type">DispatchQueue</span>&gt;

  <span class="keyword">init</span>(<span class="variable">apiClient</span>: <span class="type">ApiClient</span>, <span class="variable">scheduler</span>: <a href="/combine-schedulers/AnySchedulerOf"><span class="type">AnySchedulerOf</span></a>&lt;<span class="type">DispatchQueue</span>&gt;) {
    <span class="keyword">self</span>.<span class="variable">apiClient</span> = <span class="variable">apiClient</span>
    <span class="keyword">self</span>.<span class="variable">scheduler</span> = <span class="variable">scheduler</span>
  }

  <span class="keyword">func</span> <span class="function">reloadButtonTapped</span>() {
    <span class="keyword">self</span>.<span class="variable">apiClient</span>.<span class="variable">fetchEpisode</span>()
      .<span class="variable">receive</span>(<span class="variable">on</span>: <span class="keyword">self</span>.<span class="variable">scheduler</span>)
      .<span class="variable">assign</span>(<span class="variable">to</span>: &amp;<span class="keyword">self</span>.<span class="variable">$episode</span>)
  }
}
</code></pre></body></html>
<p>Then, in production we can create a view model that uses a live <code>DispatchQueue</code>, but we just
have to first erase its type:</p>

<html><body><pre class="highlight"><code><span class="keyword">let</span> <span class="variable">viewModel</span> = <span class="variable">EpisodeViewModel</span>(
  <span class="variable">apiClient</span>: ...,
  <span class="variable">scheduler</span>: <span class="type">DispatchQueue</span>.<span class="variable">main</span>.<span class="variable">eraseToAnyScheduler</span>()
)
</code></pre></body></html>
<p>For common schedulers, like <code>DispatchQueue</code>, <code>OperationQueue</code>, and <code>RunLoop</code>, there is even a
static helper on <code>AnyScheduler</code> that further simplifies this:</p>

<html><body><pre class="highlight"><code><span class="keyword">let</span> <span class="variable">viewModel</span> = <span class="variable">EpisodeViewModel</span>(
  <span class="variable">apiClient</span>: ...,
  <span class="variable">scheduler</span>: .<span class="variable">main</span>
)
</code></pre></body></html>
<p>And in tests we can use an immediate scheduler:</p>

<html><body><pre class="highlight"><code><span class="keyword">let</span> <span class="variable">viewModel</span> = <span class="variable">EpisodeViewModel</span>(
  <span class="variable">apiClient</span>: ...,
  <span class="variable">scheduler</span>: .<span class="variable">immediate</span>
)
</code></pre></body></html>
<p>So, in general, <code>AnyScheduler</code> is great for allowing one to control what scheduler is used
in classes, functions, etc. without needing to introduce a generic, which can help simplify
the code and reduce implementation details from leaking out.</p>

</div>
<section id="relationships">
    <h2 hidden>Relationships</h2>
        <figure>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %19 Pages: 1 -->
<svg width="872pt" height="116pt"
 viewBox="0.00 0.00 872.00 116.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 112)">
<title>%19</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-112 868,-112 868,4 -4,4"/>
<!-- AnyScheduler -->
<g id="node1" class="node structure current">
<title>AnyScheduler</title>
<g id="a_node1"><a xlink:href="/combine-schedulers/AnyScheduler" xlink:title="AnyScheduler">
<path fill="none" stroke="#000000" stroke-width="3" d="M528,-108C528,-108 336,-108 336,-108 330,-108 324,-102 324,-96 324,-96 324,-84 324,-84 324,-78 330,-72 336,-72 336,-72 528,-72 528,-72 534,-72 540,-78 540,-84 540,-84 540,-96 540,-96 540,-102 534,-108 528,-108"/>
<text text-anchor="middle" x="432" y="-86.3" font-family="Menlo" font-size="14.00" fill="#000000">AnyScheduler</text>
</a>
</g>
</g>
<!-- Scheduler -->
<g id="node2" class="node unknown">
<title>Scheduler</title>
<path fill="none" stroke="#000000" d="M528,-36C528,-36 336,-36 336,-36 330,-36 324,-30 324,-24 324,-24 324,-12 324,-12 324,-6 330,0 336,0 336,0 528,0 528,0 534,0 540,-6 540,-12 540,-12 540,-24 540,-24 540,-30 534,-36 528,-36"/>
<text text-anchor="middle" x="432" y="-14.3" font-family="Menlo" font-size="14.00" fill="#000000">Scheduler</text>
</g>
<!-- AnyScheduler&#45;&gt;Scheduler -->
<g id="edge1" class="edge conformsTo">
<title>AnyScheduler&#45;&gt;Scheduler</title>
<path fill="none" stroke="#000000" d="M432,-71.8314C432,-64.131 432,-54.9743 432,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="435.5001,-46.4132 432,-36.4133 428.5001,-46.4133 435.5001,-46.4132"/>
</g>
</g>
</svg>


    <figcaption hidden>Inheritance graph for AnyScheduler.</figcaption>
</figure>
        <h3>Conforms To</h3>
<dl>
    <dt class="unknown"><code>Scheduler</code></dt>
</dl>
</section>
    <section id="initializers">
        <h2>Initializers</h2>

        <div role="article" class="initializer" id="anyscheduler.init(minimumtolerance:now:scheduleimmediately:delayed:interval:)">
    <h3>
        <code><a href="#anyscheduler.init(minimumtolerance:now:scheduleimmediately:delayed:interval:)">init(minimum​Tolerance:​now:​schedule​Immediately:​delayed:​interval:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">init</span>(
    <span class="variable">minimumTolerance</span>: <span class="attribute">@</span><span class="attribute">escaping</span> () -&gt; <span class="type">SchedulerTimeType</span>.<span class="type">Stride</span>,
    <span class="variable">now</span>: <span class="attribute">@</span><span class="attribute">escaping</span> () -&gt; <span class="type">SchedulerTimeType</span>,
    <span class="variable">scheduleImmediately</span>: <span class="attribute">@</span><span class="attribute">escaping</span> (<span class="type">SchedulerOptions</span>?, <span class="attribute">@</span><span class="attribute">escaping</span> () -&gt; <span class="type">Void</span>) -&gt; <span class="type">Void</span>,
    <span class="variable">delayed</span>: <span class="attribute">@</span><span class="attribute">escaping</span> (
      <span class="type">SchedulerTimeType</span>, <span class="type">SchedulerTimeType</span>.<span class="type">Stride</span>, <span class="type">SchedulerOptions</span>?, <span class="attribute">@</span><span class="attribute">escaping</span> () -&gt; <span class="type">Void</span>
    ) -&gt; <span class="type">Void</span>,
    <span class="variable">interval</span>: <span class="attribute">@</span><span class="attribute">escaping</span> (
      <span class="type">SchedulerTimeType</span>, <span class="type">SchedulerTimeType</span>.<span class="type">Stride</span>, <span class="type">SchedulerTimeType</span>.<span class="type">Stride</span>, <span class="type">SchedulerOptions</span>?,
      <span class="attribute">@</span><span class="attribute">escaping</span> () -&gt; <span class="type">Void</span>
    ) -&gt; <span class="type">Cancellable</span>
  )  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Creates a type-erasing scheduler to wrap the provided endpoints.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>minimum​Tolerance</th>
    <td><code class="type">@escaping () -&gt; Scheduler​Time​Type.​Stride</code></td>
    <td><p>A closure that returns the scheduler's minimum tolerance.</p>
</td>
</tr>
<tr>
    <th>now</th>
    <td><code class="type">@escaping () -&gt; Scheduler​Time​Type</code></td>
    <td><p>A closure that returns the scheduler's current time.</p>
</td>
</tr>
<tr>
    <th>schedule​Immediately</th>
    <td><code class="type">@escaping (Scheduler​Options?, @escaping () -&gt; Void) -&gt; Void</code></td>
    <td><p>A closure that schedules a unit of work to be run as soon as possible.</p>
</td>
</tr>
<tr>
    <th>delayed</th>
    <td><code class="type">@escaping (
      Scheduler​Time​Type, Scheduler​Time​Type.​Stride, Scheduler​Options?, @escaping () -&gt; Void
    ) -&gt; Void</code></td>
    <td><p>A closure that schedules a unit of work to be run after a delay.</p>
</td>
</tr>
<tr>
    <th>interval</th>
    <td><code class="type">@escaping (
      Scheduler​Time​Type, Scheduler​Time​Type.​Stride, Scheduler​Time​Type.​Stride, Scheduler​Options?,
      @escaping () -&gt; Void
    ) -&gt; Cancellable</code></td>
    <td><p>A closure that schedules a unit of work to be performed on a repeating interval.</p>
</td>
</tr>
  </tbody>
</table>
</div>
<div role="article" class="initializer" id="anyscheduler.init(_:)">
    <h3>
        <code><a href="#anyscheduler.init(_:)">init(_:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">init</span>&lt;<span class="variable">S</span>&gt;(
    <span class="keyword">_</span> <span class="variable">scheduler</span>: <span class="type">S</span>
  )
  <span class="keyword">where</span>
    <span class="type">S</span>: <span class="type">Scheduler</span>, <span class="type">S</span>.<span class="type">SchedulerTimeType</span> == <span class="type">SchedulerTimeType</span>, <span class="type">S</span>.<span class="type">SchedulerOptions</span> == <span class="type">SchedulerOptions</span></body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Creates a type-erasing scheduler to wrap the provided scheduler.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>scheduler</th>
    <td><code class="type">S</code></td>
    <td><p>A scheduler to wrap with a type-eraser.</p>
</td>
</tr>
  </tbody>
</table>
</div>
    </section>
    <section id="properties">
        <h2>Properties</h2>

        <div role="article" class="variable" id="anyscheduler.minimumtolerance">
    <h3>
        <code><a href="#anyscheduler.minimumtolerance">minimum​Tolerance</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">var</span> <span class="variable">minimumTolerance</span>: <span class="type">SchedulerTimeType</span>.<span class="type">Stride</span>  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>The minimum tolerance allowed by the scheduler.</p>

</div>
</div>
<div role="article" class="variable" id="anyscheduler.now">
    <h3>
        <code><a href="#anyscheduler.now">now</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">var</span> <span class="variable">now</span>: <span class="type">SchedulerTimeType</span>  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>This scheduler’s definition of the current moment in time.</p>

</div>
</div>
    </section>
    <section id="methods">
        <h2>Methods</h2>

        <div role="article" class="function" id="anyscheduler.schedule(after:tolerance:options:_:)">
    <h3>
        <code><a href="#anyscheduler.schedule(after:tolerance:options:_:)">schedule(after:​tolerance:​options:​_:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">schedule</span>(
    <span class="variable">after</span> <span class="variable">date</span>: <span class="type">SchedulerTimeType</span>,
    <span class="variable">tolerance</span>: <span class="type">SchedulerTimeType</span>.<span class="type">Stride</span>,
    <span class="variable">options</span>: <span class="type">SchedulerOptions</span>?,
    <span class="keyword">_</span> <span class="variable">action</span>: <span class="attribute">@</span><span class="attribute">escaping</span> () -&gt; <span class="type">Void</span>
  )  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Performs the action at some time after the specified date.</p>

</div>
</div>
<div role="article" class="function" id="anyscheduler.schedule(after:interval:tolerance:options:_:)">
    <h3>
        <code><a href="#anyscheduler.schedule(after:interval:tolerance:options:_:)">schedule(after:​interval:​tolerance:​options:​_:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">schedule</span>(
    <span class="variable">after</span> <span class="variable">date</span>: <span class="type">SchedulerTimeType</span>,
    <span class="variable">interval</span>: <span class="type">SchedulerTimeType</span>.<span class="type">Stride</span>,
    <span class="variable">tolerance</span>: <span class="type">SchedulerTimeType</span>.<span class="type">Stride</span>,
    <span class="variable">options</span>: <span class="type">SchedulerOptions</span>?,
    <span class="keyword">_</span> <span class="variable">action</span>: <span class="attribute">@</span><span class="attribute">escaping</span> () -&gt; <span class="type">Void</span>
  ) -&gt; <span class="type">Cancellable</span>  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Performs the action at some time after the specified date, at the
specified frequency, taking into account tolerance if possible.</p>

</div>
</div>
<div role="article" class="function" id="anyscheduler.schedule(options:_:)">
    <h3>
        <code><a href="#anyscheduler.schedule(options:_:)">schedule(options:​_:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">schedule</span>(
    <span class="variable">options</span>: <span class="type">SchedulerOptions</span>?,
    <span class="keyword">_</span> <span class="variable">action</span>: <span class="attribute">@</span><span class="attribute">escaping</span> () -&gt; <span class="type">Void</span>
  )  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Performs the action at the next possible opportunity.</p>

</div>
</div>
    </section>



        </article>
    </main>

    <footer>
        <p>
    Generated on <time datetime="2021-09-21T14:38:25+0000">September 21, 2021</time> using <a href="https://github.com/SwiftDocOrg/swift-doc">swift-doc</a> <span class="version">1.0.0-rc.1</span>.
</p>
    </footer>
</body>
</html>
